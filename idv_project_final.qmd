---
title: "IDV project"
author: "Maikki Heijala"
format: 
  dashboard:
    orientation: columns
    theme: flatly
    expandable: false
---
```{r data_handling}
#| include: false
#| warning: false

library(rjson)
library(dplyr)
library(purrr)

for_rent <- fromJSON(file="for_rent.json")
for_rent2 <- fromJSON(file="for_rent2.json")
for_sale <- fromJSON(file="for_sale.json")
age <- fromJSON(file="age.json")
education <- fromJSON(file="education.json")

codes_names <- as.data.frame(
  do.call(
    rbind,
    for_rent$dataset$dimension$Postinumero$category$label
  )
)
codes_names$names <- rownames(codes_names)
names <- codes_names$V1

filtered_for_sale <- 
  tibble(
    info = map(for_sale$data, "key"),
    price = map_chr(for_sale$data, "values")
  ) %>% 
  mutate(
    year = map_chr(info, 1),
    code = map_chr(info, 2) 
  ) %>%
  select(
    code, year, price
  ) %>%
  mutate(
    price = as.integer((price)),
    year = substring(year, 1, 4)
  ) %>%
  na.omit() %>%
  group_by(code, year) %>%
  summarise(price_avg = mean(price)) %>%
  mutate(price_avg = round(price_avg, 0))

filtered_for_rent <- 
  tibble(
    info = map(for_rent2$data, "key"),
    price = map_chr(for_rent2$data, "values")
  ) %>% 
  mutate(
    year = map_chr(info, 1),
    code = map_chr(info, 2) 
  ) %>%
  select(
    code, year, price
  ) %>%
  mutate(
    price = as.integer((price)),
    year = substring(year, 1, 4)
  ) %>%
  na.omit() %>%
  group_by(code, year) %>%
  summarise(price_avg = mean(price)) %>%
  mutate(price_avg = round(price_avg, 0))

ojs_define(names)
ojs_define(for_sale)
ojs_define(for_rent)
ojs_define(filtered_for_sale)
ojs_define(filtered_for_rent)
ojs_define(age)
ojs_define(education)

```
## Column {width="30%"}

```{r}
#| title: "Price Ranges on  Map"
#| padding: 10px

print("Hello Hey!")

```

## Column

### Row {height=60%}

#### Column

#### Row

```{ojs}
//| title: Area selection

viewof chosen_area = Inputs.select(names)

header_name = chosen_area.split(' (')[0];
chosen_code = header_name.split(' ')[0]
html`<h3>${header_name}</h3>`

```

##### Column
```{r}
#| content: valuebox
#| title: "Highest e/m2 in area"
list(
  icon = "arrow-up-right",
  color = "success",
  value = 90
)
```

##### Column
```{r}
#| content: valuebox
#| title: "Lowest e/m2 in area"
list(
  icon = "arrow-down-right",
  color = "warning",
  value = 60
)
```

#### Row

```{ojs}
//| title: Market type selection

viewof market = Inputs.radio(["for rent", "for sale"], {value: "for rent"})

```

##### Column
```{r}
#| content: valuebox
#| title: "Highest e/m2 in Finland"
list(
  icon = "graph-up-arrow",
  color = "light",
  value = 110
)
```

##### Column
```{r}
#| content: valuebox
#| title: "Lowest e/m2 in Finland"
list(
  icon = "graph-down-arrow",
  color = "light",
  value = 50
)
```

#### Column

```{ojs}
//| title: 5 year development

function get_linedata(m) {
  if (m == "for sale") {
    return [transpose(filtered_for_sale), 10000]
  }
  return [transpose(filtered_for_rent), 50]
}

linedata = get_linedata(market)
data = linedata[0]
y_limit = linedata[1]

t_linedata = data.filter(row => row.code === chosen_code)

Plot.plot({
  marginTop: 100,
  marginRight: 50,
  marginBottom: 50,
  marginLeft: 50,
  height: 450,
  width: 350,
  y: {
    grid: true,
    domain: [0, y_limit],
  },
  x: {
    domain: [2019, 2023],
    tickFormat: "",
    interval: 1
  },
  marks: [
    Plot.ruleY([0]),
    Plot.dot(t_linedata, {x: "year", y: "price_avg", channels: {year: "year", price_avg: "price"}, tip: true}),
    Plot.areaY(t_linedata, {x: "year", y: "price_avg", fillOpacity: 0.1}),
    Plot.lineY(t_linedata, {x: "year", y: "price_avg"}),
    Plot.frame()
  ]
})


```

### Row {.tabset}

```{ojs}
//| title: Age

"Age info here"

```


```{ojs}
//| title: Education

"Education info here"

```
